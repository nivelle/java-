### 线程本地存储模式

- 避免共享：并发问题是因为同时操作共享变量引起的，为了避免线程安全问题，避免共享，这样也能解决线程安全问题

- 局部变量、线程本地存储（threadLocal）都能实现避免变量的共享

#### java ThreadLocal实现的优势

- threadLocal仅仅是一个代理工具类，内部不持有任何与线程相关的数据

- 所有和线程相关的数据都存储在Thread里面，仅仅是操作权交给了ThreadLocal

- 不容易产生内容泄露: Thread 持有ThreadLocalMap,而且ThreadLocalMap 里对ThreadLocal是弱引用，所以只要Thread对象可以回收，那么ThreadLocalMap就能被 回收。

- 线程池中使用ThreadLocal 容易导致内存泄露，因为线程池内的线程生命周期太长，导致Thread持有的ThreadLocalMap一直不会被回收，再加上ThreadLocalMap 中的Entry
  对ThreadLocal是弱引用，所以只要ThreadLocal结束了生命周期是可以被回收的。但是Entry中的value却被Entry强引用的，所以即便value生命周期结束了，value也无法被回收，导致内存泄露

[![yZsSZd.png](https://s3.ax1x.com/2021/02/01/yZsSZd.png)](https://imgchr.com/i/yZsSZd)

1. 对threadLocal的引用有两个，一个是显示的强引用，来自对ThreadLocal的定义

2. ThreadLocalMap 中的Entry的key 对threadLocal有一个弱引用

3. Thread 线程对ThreadLocalMap 的 Entry有一个强引用