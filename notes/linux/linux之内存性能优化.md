### 内存映射

- linux 内核给每个进程都提供了一个独立的虚拟地址空间，并且这个地址空间是连续的。这样，进程就可以很方便地访问内存，更确切的说是访问虚拟内存。

- 虽然每个进程的地址空间都包含了内核空间，但这些内核空间，其实关联的都是相同的物理内存。

- 并不是所有的虚拟内存都会分配物理内存，只有那些实际使用的虚拟内存才分配物理内存，并且分配后的物理内存，是通过内存映射来管理的

- 内存映射，其实就是将虚拟内存地址映射到物理内存地址。为了完成内存映射，内核为每个进程都维护了一张页表，记录虚拟地址与物理地址的映射关系

#### 虚拟内存空间分布

[![sbfwt0.png](https://s3.ax1x.com/2021/01/24/sbfwt0.png)](https://imgchr.com/i/sbfwt0)

1. 只读段，包括代码和常量等。
   
2. 数据段，包括全局变量等。
   
3. 堆，包括动态分配的内存，从低地址开始向上增长。 
   
4.文件映射段，包括动态库、共享内存等，从高地址开始向下增长。

5. 栈，包括局部变量和函数调用的上下文等。栈的大小是固定的，一般是 8 MB。

其中堆和文件映射端段的内存是动态分配的。比如C标准库的malloc()或者mmap(),就可以分别在堆和文件映射段动态分配内存。

#### 内存分配与回收

malloc()是C标准库提供的内存分配函数，对应到系统调用上，有两种实现方案：

- brk():小块内存小于128K ,通过移动堆顶的位置来分配内存，这些内存释放后并不会立刻归还系统，而是被缓存起来，这样可以重复使用

- mmap():直接使用内存映射 mmap() 来分配，也就是在文件映射段找一块空闲内存分配出去

内存如果只分配不释放














