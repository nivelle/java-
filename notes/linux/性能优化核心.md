
### 优化点思维导图

[![sIjA91.jpg](https://s3.ax1x.com/2021/01/22/sIjA91.jpg)](https://imgchr.com/i/sIjA91)

#### 测试工具

- yum install sysbench //基准测试


1. 多线程切换

````
# 以10个线程运行5分钟的基准测试，模拟多线程切换的问题
$ sysbench --threads=10 --max-time=300 threads run

````
- yum install stress //压力测试

2. CPU 使用率100%

````

$ stress --cpu 1 --timeout 600

````

3. I/O 压力

````

$ stress -i 1 --timeout 600

````

- yum install perf //指定应用层序性能问题

4. perf top //CPU 使用率过高分析工具

````
Samples【采样数】: 1K of event【事件类型】 'cpu-clock', 4000 Hz, Event count【事件总数量】 (approx.): 68944906
Overhead  Shared      Object            Symbol
  18.38%  [kernel]    [k]         finish_task_switch
   9.04%  [kernel]    [k]         _raw_spin_unlock_irqrestore
10.78%  [unknown]     [.]        0x000055c6a5541dc1



````
- Overhead： 是该符号的性能事件在所有采样中的比例，用百分比来表示

- Shared： 是该函数或指令所在的动态共享对象（Dynamic Shared Object），如内核、进程名、动态链接库名、内核模块名等

- Object:是动态共享对象的类型。比如 [.] 表示用户空间的可执行程序、或者动态链接库，而 [k] 则表示内核空间

- Symbol: ，也就是函数名。当函数名未知时，用十六进制的地址来表示。
































#### uptime

````
 18:03:55 up 73 days, 17:42,  1 user,  load average: 0.01, 0.06, 0.02
````
- 18:03:55 //当前时间
- up 73 days, 17:42 //系统运行时间
- 1 user //正在登陆用户数
- load average: 0.01, 0.06, 0.02 //过去1分钟，5分钟，15分钟 的平均负载

##### load average

- 单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数目。和CPU使用率没有直接关系。   

### cpu 上下文切换

CPU 寄存器，是 CPU 内置的容量小、但速度极快的内存。而程序计数器，则是用来存储 CPU 正在执行的指令位置、或者即将执行的下一条指令位置。它们都是 CPU 在运行任何任务前，必须的依赖环境，因此也被叫做 CPU 上下文。

1. 进程上下文切换

- 进程上下文切换，是指从一个进程切换到另一个进程运行

- 而系统调用过程中一直是同一个进程在运行，一次系统调用的过程，其实是发生了两次CPU 上下文切换

(1)、根据调度策略，将CPU时间划片为对应的时间片，当时间片耗尽，当前进程必须挂起。

(2)、资源不足的，在获取到足够资源之前进程挂起。

(3)、进程sleep挂起进程。

(4)、高优先级进程导致当前进度挂起

(5)、硬件中断，导致当前进程挂起

2. 线程上下文切换

**线程是调度的基本单位，而进程则是资源拥有的基本单位**

- 当进程只有一个线程时，可以认为进程就属于线程

- 当进程拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源。这些资源在上下文切换时是不需要修改的

- 线程也有自己的私有数据，栈、寄存器等，这些在上下文切换时也需要保存

(1)、不通进程之间的线程上下文切换，其过程和进程上下文切换大致相同。

(2)、进程内部的线程进上下文切换。不需要切换进程的用户资源，只需要切换线程私有的数据和寄存器

3. 中断上下文切换

- 中断处理会打断进程的正常调度和执行，转而调用中断处理程序，响应设备事件

- 同一个CPU来说，中断处理比进程拥有更高的优先级，中断上下文切换并不会与进程上下文切换同时发生。

#### 中断状态查看

- 中断发生在内核态

- 从 /proc/interrupts 只读文件，/proc 是Linux 的一个虚拟文件系统，用于 内核空间与用户空间之间的通信。

1. 自愿上下文切换变多了，说明进程都在等待资源，有可能发生了 I/O 等其他问题；
   
2. 非自愿上下文切换变多了，说明进程都在被强制调度，也就是都在争抢 CPU，说明 CPU 的确成了瓶颈；
   
3. 中断次数变多了，说明 CPU 被中断处理程序占用，还需要通过查看 /proc/interrupts 文件来分析具体的中断类型。

### CPU 使用率

- linux 通过 CPU 接拍率（内核中表示为HZ），触发时间中断，使用全局变量 Jiffies 记录开机以来的节拍树。每发生一次中断，jiffies的值就加1

````
grep 'CONFIG_HZ=' /boot/config-$(uname -r)
CONFIG_HZ=1000

````

- 为了方便用户空间程序，内核还提供了一个用户空间节拍率 USER_HZ，它总是固定为 100，也就是 1/100 秒

````
cat /proc/stat | grep ^cpu
cpu  2467635 287 1424282 638899051 25175 0 335 0 0 0
cpu0 2467635 287 1424282 638899051 25175 0 335 0 0 0

````