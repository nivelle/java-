### 消息的作用

- 削峰填谷

### 消息引入的衍生问题

- 数据的非强一致性问题

![常见消息队列对比.png.png](https://i.loli.net/2021/11/12/K9X51sqz8voGRbl.png)


### 生产者消息丢失

#### 关键词：本地事务、回调

异步发送分为两个方式：异步有回调和异步无回调，无回调的方式，生产者发送完后不管结果可能就会造成消息丢失，而通过异步发送+回调通知+本地消息表的形式我们就可以做出一个解决方案。以下单的场景举例。

- 下单后先保存本地数据和MQ消息表，这时候消息的状态是发送中，如果本地事务失败，那么下单失败，事务回滚。
- 下单成功，直接返回客户端成功，异步发送MQ消息
- MQ回调通知消息发送结果，对应更新数据库MQ发送状态
- JOB轮询超过一定时间（时间根据业务配置）还未发送成功的消息去重试
- 在监控平台配置或者JOB程序处理超过一定次数一直发送不成功的消息，告警，人工介入。

### MQ消息丢失

##### 关键词: 中间件持久化、副本
